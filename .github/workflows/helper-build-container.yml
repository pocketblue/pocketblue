on:
  workflow_call:
    inputs:
      from_tag:
        required: true
        type: string
      from_image:
        required: true
        type: string
      target_image:
        required: true
        type: string
      context:
        required: true
        type: string
      rechunk:
        required: true
        type: boolean
    outputs:
      target_tag:
        value: ${{ jobs.build.outputs.target_tag }}
      registry:
        value: ${{ jobs.build.outputs.registry }}

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    permissions:
      packages: write
    outputs:
      target_tag: ${{ steps.config.outputs.target_tag }}
      registry: ${{ steps.config.outputs.registry }}
    steps:
      - uses: actions/checkout@v4
      - name: config
        id: config
        uses: pocketblue/actions/container-config@main
        with:
          from_tag: ${{ inputs.from_tag }}
          vars_registry: ${{ vars.REGISTRY }}
      - name: build
        id: build
        run: |
          sudo buildah bud \
            --build-arg 'from=${{ inputs.from_image }}:${{ inputs.from_tag }}' \
            -t '${{ inputs.target_image }}:${{ steps.config.outputs.target_tag }}' \
            ${{ steps.config.outputs.expires && '--label quay.expires-after=1w' || '' }} \
            ${{ inputs.context }}
      - name: version
        id: version
        if: inputs.rechunk
        shell: bash
        run: |
          export full_version=$(sudo podman inspect '${{ inputs.from_image }}:${{ inputs.from_tag }}' --format '{{ index .Config.Labels "org.opencontainers.image.version" }}')
          echo version=$(echo $full_version | cut -d. -f1-2) >> $GITHUB_OUTPUT
      - id: rechunk
        if: inputs.rechunk
        uses: hhd-dev/rechunk@ded27feba22df48134eece2c66ba0fca1289ff40 # v1.2.3
        with:
          rechunk: 'ghcr.io/hhd-dev/rechunk:v1.2.3'
          prev-ref: ${{ steps.config.outputs.registry }}/${{ inputs.target_image }}:${{ steps.config.outputs.target_tag }}
          ref: localhost/${{ inputs.target_image }}:${{ steps.config.outputs.target_tag }}
          version: ${{ steps.version.outputs.version }}
          pretty: ${{ steps.version.outputs.version }}
          revision: ${{ github.sha }}
          skip_compression: true
      - uses: pocketblue/actions/container-push@main
        env:
          latest: ${{ steps.config.outputs.latest }}
          rechunk_ref: ${{ steps.rechunk.outputs.ref || '' }}
          username: ${{ vars.REGISTRY_USERNAME != '' && vars.REGISTRY_USERNAME || github.repository_owner }}
          password: ${{ secrets.REGISTRY_TOKEN != '' && secrets.REGISTRY_TOKEN || secrets.GITHUB_TOKEN }}
          registry: ${{ steps.config.outputs.registry }}
          image: ${{ inputs.target_image }}
          tag: ${{ steps.config.outputs.target_tag }}
