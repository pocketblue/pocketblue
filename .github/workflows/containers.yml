name: containers
on:
  workflow_dispatch:
    inputs:
      fedora_branch:
        type: choice
        description: 'fedora branch'
        required: true
        options:
          - '42'
          - '43'
          - 'rawhide'
        default: '42'
  push:
    paths:
      - 'base/**'
      - 'devices/**'
      - 'desktops/**'

run-name: "containers: fedora ${{ inputs.fedora_branch || 42 }} ${{ github.event_name == 'push' && format(' | {0}', github.event.head_commit.message) }}"

jobs:
  base:
    name: base
    secrets: inherit
    permissions:
      packages: write
    uses: ./.github/workflows/helper-build-container.yml
    with:
      from_tag: ${{ inputs.fedora_branch || 42 }}
      from_image: quay.io/fedora/fedora-bootc
      target_image: base
      context: base
      rechunk: false

  devices:
    needs: base
    name: ${{ matrix.device }}-base:${{ needs.base.outputs.target_tag }}
    permissions:
      packages: write
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        device: [ xiaomi-nabu, xiaomi-pipa, oneplus-sdm845, nothing-spacewar ]
    uses: ./.github/workflows/helper-build-container.yml
    with:
      from_tag: ${{ needs.base.outputs.target_tag }}
      from_image: ${{ needs.base.outputs.registry }}/base
      target_image: ${{ matrix.device }}-base
      context: devices/${{ matrix.device }}
      rechunk: false

  desktops:
    needs: devices
    name: ${{ matrix.device }}-${{ matrix.desktop }}:${{ needs.devices.outputs.target_tag }}
    permissions:
      packages: write
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        device: [ xiaomi-nabu, xiaomi-pipa, oneplus-sdm845, nothing-spacewar ]
        desktop: [ gnome-mobile, gnome-desktop, phosh, plasma-desktop, plasma-mobile ]
    uses: ./.github/workflows/helper-build-container.yml
    with:
      from_tag: ${{ needs.devices.outputs.target_tag }}
      from_image: ${{ needs.devices.outputs.registry }}/${{ matrix.device }}-base
      target_image: ${{ matrix.device }}-${{ matrix.desktop }}
      context: desktops/${{ matrix.desktop }}
      rechunk: true
