#!/bin/sh
set -e

BT_INDEX="0"
MAC_PREFIX="0200"
BT_TIMEOUT=5

echo "Generating Bluetooth MAC address"

SERIAL_NUMBER=$(grep -o "serialno.*" /proc/cmdline | cut -d" " -f1)

if [ -z "$SERIAL_NUMBER" ]; then
    echo "Serial number not available, falling back to machine-id"
    SERIAL_NUMBER=$(cat /etc/machine-id)
fi

if [ -z "$SERIAL_NUMBER" ]; then
    echo "No unique ID available, cannot generate MAC address"
    exit 1
fi

BT_MAC=$(echo "$SERIAL_NUMBER-BT" | sha256sum | awk -v prefix="$MAC_PREFIX" '{printf("%s%010s\n", prefix, $1)}')
BT_MAC=$(echo "$BT_MAC" | cut -c1-12 | sed 's/\(..\)/\1:/g' | sed '$s/:$//')

echo "Setting Bluetooth MAC to $BT_MAC"

set +e
BT_RFKILL_UNBLOCKED=$(rfkill -n -r -o DEVICE,TYPE,SOFT | grep "bluetooth" | grep "unblocked")
set -e

bt_mgmt_cmd() {
    printf 'menu mgmt\nselect %s\n%s\nquit\n' "$BT_INDEX" "$*" | bluetoothctl 2>&1
}

bt_mgmt_cmd power off

timeout=0
while [ $timeout -lt "$BT_TIMEOUT" ]; do
    if bt_mgmt_cmd public-addr "$BT_MAC" | grep -q "Set public address successfully"; then
        break
    fi
    echo "Unable to set Bluetooth MAC, retrying after 1 second..."
    sleep 1
    timeout=$((timeout + 1))
done

if [ $timeout -ge "$BT_TIMEOUT" ]; then
    echo "Failed to set Bluetooth MAC address after $BT_TIMEOUT seconds"
    exit 1
fi

if [ -n "$BT_RFKILL_UNBLOCKED" ]; then
    echo "Restoring Bluetooth rfkill state to unblocked"
    rfkill unblock bluetooth
    bt_mgmt_cmd power on
fi

echo "Bluetooth MAC address configured successfully"
