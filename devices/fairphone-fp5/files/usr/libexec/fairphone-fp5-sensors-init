#!/bin/bash
set -e

echo "Fairphone 5 sensor initialization starting..."

ADSP_TIMEOUT=60
SENSOR_FW_PATH="/usr/share/qcom/qcm6490/fairphone5/sensors"

wait_for_fastrpc_device() {
    local timeout=$1
    local device=$2
    local waited=0

    while [ $waited -lt $timeout ]; do
        if [ -c "/dev/${device}" ]; then
            echo "${device} device ready after ${waited}s"
            return 0
        fi
        sleep 1
        ((waited++))
    done

    echo "ERROR: ${device} device not available after ${timeout}s"
    return 1
}

if ! wait_for_fastrpc_device $ADSP_TIMEOUT "fastrpc-adsp"; then
    echo "ERROR: fastrpc-adsp device not available"
    exit 1
fi

chmod 0666 /dev/fastrpc-adsp 2>/dev/null || true
chmod 0666 /dev/fastrpc-cdsp 2>/dev/null || true

if [ -d "$SENSOR_FW_PATH" ]; then
    echo "Sensor firmware found at $SENSOR_FW_PATH"
else
    echo "WARNING: Sensor firmware not found at $SENSOR_FW_PATH"
fi

waited=0
timeout=30
while [ $waited -lt $timeout ]; do
    if systemctl is-active --quiet hexagonrpcd-adsp-sensorspd.service; then
        echo "hexagonrpcd-adsp-sensorspd is active after ${waited}s"
        break
    fi
    sleep 1
    ((waited++))
done

if [ $waited -ge $timeout ]; then
    echo "WARNING: hexagonrpcd-adsp-sensorspd not active after ${timeout}s"
fi

udevadm control --reload-rules 2>/dev/null || true
udevadm trigger --subsystem-match=misc --action=change 2>/dev/null || true
udevadm settle --timeout=5 2>/dev/null || true

echo "Checking libssc availability..."
if [ -f /usr/lib64/libssc.so ] || [ -f /usr/lib/libssc.so ]; then
    echo "  libssc: found"
else
    echo "  libssc: NOT found"
fi

echo "Checking iio-sensor-proxy SSC support..."
if strings "$(command -v iio-sensor-proxy 2>/dev/null)" 2>/dev/null | grep -q "ssc\|SSC\|fastrpc"; then
    echo "  iio-sensor-proxy: has SSC support"
else
    echo "  iio-sensor-proxy: NO SSC support (stock Fedora build)"
    echo "  Sensors will NOT work without iio-sensor-proxy-ssc package"
fi

echo "Sensor initialization complete"
