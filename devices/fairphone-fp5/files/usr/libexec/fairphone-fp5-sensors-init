#!/bin/bash
set -e

echo "Fairphone 5 sensor initialization starting..."

ADSP_TIMEOUT=60
SENSOR_FW_PATH="/usr/share/qcom/qcm6490/fairphone5/sensors"

wait_for_fastrpc_device() {
    local timeout=$1
    local device=$2
    local waited=0

    while [ $waited -lt $timeout ]; do
        if [ -c "/dev/${device}" ]; then
            echo "${device} device ready after ${waited}s"
            return 0
        fi
        sleep 1
        ((waited++))
    done

    echo "ERROR: ${device} device not available after ${timeout}s"
    return 1
}

if ! wait_for_fastrpc_device $ADSP_TIMEOUT "fastrpc-adsp"; then
    echo "ERROR: fastrpc-adsp device not available"
    exit 1
fi

chmod 0666 /dev/fastrpc-adsp 2>/dev/null || true
chmod 0666 /dev/fastrpc-cdsp 2>/dev/null || true

if [ -d "$SENSOR_FW_PATH" ]; then
    echo "Sensor firmware found at $SENSOR_FW_PATH"
else
    echo "WARNING: Sensor firmware not found at $SENSOR_FW_PATH"
fi

waited=0
timeout=30
while [ $waited -lt $timeout ]; do
    if systemctl is-active --quiet hexagonrpcd-adsp-sensorspd.service; then
        echo "hexagonrpcd-adsp-sensorspd is active after ${waited}s"
        break
    fi
    sleep 1
    ((waited++))
done

if [ $waited -ge $timeout ]; then
    echo "WARNING: hexagonrpcd-adsp-sensorspd not active after ${timeout}s"
fi

waited=0
timeout=15
while [ $waited -lt $timeout ]; do
    if ls /sys/bus/qrtr/devices/* &>/dev/null; then
        echo "QRTR bus available after ${waited}s"
        break
    fi
    sleep 1
    ((waited++))
done

if [ $waited -ge $timeout ]; then
    echo "WARNING: QRTR bus not available after ${timeout}s"
fi

udevadm control --reload-rules 2>/dev/null || true
udevadm trigger --subsystem-match=misc --action=change 2>/dev/null || true
udevadm settle --timeout=5 2>/dev/null || true

echo "Sensor initialization complete"
