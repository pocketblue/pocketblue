#!/bin/bash
set -e

echo "Fairphone 5 sensor initialization starting..."

ADSP_TIMEOUT=60
SENSOR_FW_PATH="/usr/share/qcom/qcm6490/fairphone5/sensors"

wait_for_fastrpc_device() {
    local timeout=$1
    local device=$2
    local waited=0
    
    while [ $waited -lt $timeout ]; do
        if [ -c "/dev/${device}" ]; then
            echo "${device} device ready after ${waited}s"
            return 0
        fi
        echo "Waiting for ${device} device... ($waited/${timeout}s)"
        sleep 1
        ((waited++))
    done
    
    echo "ERROR: ${device} device not available after ${timeout}s"
    return 1
}

wait_for_hexagonrpcd() {
    local timeout=30
    local waited=0
    
    echo "Waiting for hexagonrpcd to initialize sensors domain..."
    
    while [ $waited -lt $timeout ]; do
        if systemctl is-active --quiet hexagonrpcd-adsp-sensorspd.service; then
            echo "hexagonrpcd-adsp-sensorspd is active"
            return 0
        fi
        sleep 1
        ((waited++))
    done
    
    echo "WARNING: hexagonrpcd-adsp-sensorspd not active after ${timeout}s"
    return 1
}

if ! wait_for_fastrpc_device $ADSP_TIMEOUT "fastrpc-adsp"; then
    echo "ERROR: fastrpc-adsp device not available"
    exit 1
fi

chmod 0666 /dev/fastrpc-adsp 2>/dev/null || true
chmod 0666 /dev/fastrpc-cdsp 2>/dev/null || true

mkdir -p /var/lib/sensors

if [ -d "$SENSOR_FW_PATH" ]; then
    echo "Sensor firmware found at $SENSOR_FW_PATH"
    echo "Contents:"
    ls -la "$SENSOR_FW_PATH/" 2>/dev/null || echo "  (empty or not accessible)"
else
    echo "WARNING: Sensor firmware not found at $SENSOR_FW_PATH"
fi

sleep 2

wait_for_hexagonrpcd || echo "Continuing with sensor setup..."

udevadm trigger --subsystem-match=iio --action=change 2>/dev/null || true

udevadm trigger --subsystem-match=misc --action=change 2>/dev/null || true

sleep 2

echo "Checking for IIO devices..."
if [ -d /sys/bus/iio/devices ]; then
    for dev in /sys/bus/iio/devices/iio:device*; do
        if [ -d "$dev" ]; then
            name=$(cat "$dev/name" 2>/dev/null || echo "unknown")
            echo "  Found IIO device: $(basename $dev) - $name"
        fi
    done
else
    echo "  No IIO devices found (may appear later via libssc)"
fi

echo "Sensor initialization complete"
echo "Note: Sensors are accessed via libssc/ADSP, not direct IIO"
