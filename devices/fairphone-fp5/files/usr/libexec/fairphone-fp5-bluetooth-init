#!/bin/bash

HCI_DEV="hci0"
TIMEOUT=30

echo "Fairphone 5 Bluetooth initialization (WCN6750)..."

for hci in /sys/class/bluetooth/hci*; do
    if [ -d "$hci" ]; then
        HCI_DEV=$(basename "$hci")
        break
    fi
done

if [ ! -d "/sys/class/bluetooth/$HCI_DEV" ]; then
    echo "ERROR: No Bluetooth HCI device found"
    exit 1
fi

echo "Found $HCI_DEV"

if command -v rfkill &>/dev/null; then
    rfkill unblock bluetooth 2>/dev/null || true
fi

waited=0
while [ $waited -lt $TIMEOUT ]; do
    if dmesg 2>/dev/null | grep -q "QCA setup on UART is completed"; then
        echo "QCA firmware loaded after ${waited}s"
        break
    fi
    sleep 1
    ((waited++))
done

if [ $waited -ge $TIMEOUT ]; then
    echo "WARNING: Timed out waiting for QCA firmware (${TIMEOUT}s)"
    echo "Check dmesg for bluetooth firmware errors"
    exit 1
fi

sleep 1

echo "Bluetooth $HCI_DEV ready â€” handing off to bluetoothd"
exit 0
