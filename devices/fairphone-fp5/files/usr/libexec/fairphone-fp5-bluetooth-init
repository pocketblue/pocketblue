#!/bin/bash

HCI_DEV="hci0"

echo "Fairphone 5 Bluetooth initialization (WCN6750)..."

wait_for_hci_device() {
    local timeout=30
    local waited=0

    while [ $waited -lt $timeout ]; do
        if [ -d "/sys/class/bluetooth/$HCI_DEV" ]; then
            echo "Bluetooth device $HCI_DEV appeared after ${waited}s"
            return 0
        fi
        for hci in /sys/class/bluetooth/hci*; do
            if [ -d "$hci" ]; then
                HCI_DEV=$(basename "$hci")
                echo "Bluetooth device $HCI_DEV appeared after ${waited}s"
                return 0
            fi
        done
        sleep 1
        ((waited++))
    done

    echo "ERROR: No Bluetooth HCI device found after ${timeout}s"
    return 1
}

if ! wait_for_hci_device; then
    echo "Bluetooth HCI device not available. Check firmware and dmesg."
    exit 1
fi

if command -v rfkill &>/dev/null; then
    rfkill unblock bluetooth 2>/dev/null || true
fi

echo "Bluetooth $HCI_DEV ready â€” handing off to bluetoothd"
exit 0
