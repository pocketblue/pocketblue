#!/bin/bash
set -e

HCI_DEV="hci0"
MAX_RETRIES=10
WCNSS_TIMEOUT=90

echo "Fairphone 5 Bluetooth initialization (WCN6750 via WCNSS)..."

wait_for_wcnss_remoteproc() {
    local timeout=$WCNSS_TIMEOUT
    local waited=0
    
    echo "Waiting for WCNSS/WPSS remoteproc to be running..."
    
    while [ $waited -lt $timeout ]; do
        for rproc in /sys/class/remoteproc/remoteproc*/; do
            if [ -f "${rproc}name" ]; then
                local name=$(cat "${rproc}name" 2>/dev/null)
                if echo "$name" | grep -qiE "wpss|wcnss"; then
                    local state=$(cat "${rproc}state" 2>/dev/null)
                    if [ "$state" = "running" ]; then
                        echo "WCNSS/WPSS remoteproc ($name) is running after ${waited}s"
                        return 0
                    fi
                fi
            fi
        done
        sleep 1
        ((waited++))
    done
    
    echo "WARNING: WCNSS/WPSS remoteproc not running after ${timeout}s"
    echo "Available remoteprocs:"
    for rproc in /sys/class/remoteproc/remoteproc*/; do
        if [ -f "${rproc}name" ]; then
            echo "  $(basename $rproc): $(cat ${rproc}name 2>/dev/null) - $(cat ${rproc}state 2>/dev/null)"
        fi
    done
    return 1
}

wait_for_hci_device() {
    local timeout=60
    local waited=0
    
    echo "Waiting for Bluetooth HCI device..."
    
    while [ $waited -lt $timeout ]; do
        if [ -d "/sys/class/bluetooth/$HCI_DEV" ]; then
            echo "Bluetooth device $HCI_DEV found after ${waited}s"
            return 0
        fi
        
        for hci in /sys/class/bluetooth/hci*; do
            if [ -d "$hci" ]; then
                HCI_DEV=$(basename "$hci")
                echo "Bluetooth device $HCI_DEV found after ${waited}s"
                return 0
            fi
        done
        
        sleep 1
        ((waited++))
    done
    
    echo "ERROR: No Bluetooth HCI device found after ${timeout}s"
    return 1
}

check_firmware_files() {
    echo "Checking Bluetooth firmware files..."
    
    local fw_ok=true
    
    if [ -f /usr/lib/firmware/qca/msbtfw11.mbn ]; then
        echo "  ✓ msbtfw11.mbn found"
    else
        echo "  ✗ msbtfw11.mbn NOT found"
        fw_ok=false
    fi
    
    if [ -f /usr/lib/firmware/qca/msbtfw11.tlv ] || [ -L /usr/lib/firmware/qca/msbtfw11.tlv ]; then
        echo "  ✓ msbtfw11.tlv found (or symlink)"
    else
        echo "  Creating symlink msbtfw11.tlv -> msbtfw11.mbn..."
        if [ -f /usr/lib/firmware/qca/msbtfw11.mbn ]; then
            ln -sf msbtfw11.mbn /usr/lib/firmware/qca/msbtfw11.tlv
            echo "  ✓ Created symlink"
        else
            fw_ok=false
        fi
    fi
    
    if [ -f /usr/lib/firmware/qca/msnv11.bin ]; then
        echo "  ✓ msnv11.bin found"
    else
        echo "  ⚠ msnv11.bin NOT found (NVM data)"
    fi
    
    return 0
}

check_bt_status() {
    if [ ! -d "/sys/class/bluetooth/$HCI_DEV" ]; then
        return 1
    fi
    
    if hciconfig "$HCI_DEV" 2>/dev/null | grep -q "UP RUNNING"; then
        return 0
    fi
    
    return 1
}

bring_up_bluetooth() {
    echo "Configuring Bluetooth interface..."
    
    if command -v rfkill &>/dev/null; then
        echo "  Unblocking Bluetooth via rfkill..."
        rfkill unblock bluetooth 2>/dev/null || true
        sleep 1
    fi
    
    echo "  Bringing down $HCI_DEV..."
    hciconfig "$HCI_DEV" down 2>/dev/null || true
    sleep 1
    
    echo "  Bringing up $HCI_DEV..."
    if hciconfig "$HCI_DEV" up 2>/dev/null; then
        return 0
    fi
    return 1
}

echo ""
echo "=== Phase 1: Check firmware files ==="
check_firmware_files

echo ""
echo "=== Phase 2: Wait for WCNSS subsystem ==="
if ! wait_for_wcnss_remoteproc; then
    echo "WCNSS not ready - Bluetooth may not work"
    echo "Check if wpss firmware is loading: dmesg | grep -i wpss"
fi

sleep 3

echo ""
echo "=== Phase 3: Wait for HCI device ==="
if ! wait_for_hci_device; then
    echo "No HCI device available"
    echo ""
    echo "Debugging info:"
    echo "  Kernel modules:"
    lsmod | grep -E "bluetooth|btqca|hci|wcn" || echo "    (none found)"
    echo "  rfkill status:"
    rfkill list bluetooth 2>/dev/null || echo "    (rfkill not available)"
    echo "  dmesg bluetooth:"
    dmesg | grep -i bluetooth | tail -10 || echo "    (no bluetooth messages)"
    exit 1
fi

echo ""
echo "=== Phase 4: Configure Bluetooth interface ==="

if check_bt_status; then
    echo "Bluetooth $HCI_DEV is already UP and RUNNING"
    hciconfig "$HCI_DEV"
    exit 0
fi

for retry in $(seq 1 $MAX_RETRIES); do
    echo "Attempt ${retry}/${MAX_RETRIES}..."
    
    if bring_up_bluetooth; then
        sleep 2
        if check_bt_status; then
            echo ""
            echo "✓ Bluetooth $HCI_DEV initialized successfully"
            hciconfig "$HCI_DEV"
            exit 0
        fi
    fi
    
    echo "  Attempt $retry failed, waiting before retry..."
    sleep $((2 + retry))
done

if command -v btmgmt &>/dev/null; then
    echo ""
    echo "Trying btmgmt as fallback..."
    btmgmt power off 2>/dev/null || true
    sleep 2
    btmgmt power on 2>/dev/null || true
    sleep 2
    
    if check_bt_status; then
        echo "✓ Bluetooth $HCI_DEV initialized via btmgmt"
        hciconfig "$HCI_DEV"
        exit 0
    fi
fi

echo ""
echo "⚠ Bluetooth initialization incomplete"
echo "Final status:"
hciconfig "$HCI_DEV" 2>/dev/null || echo "  Device not accessible"
echo ""
echo "Troubleshooting:"
echo "  1. Check WCNSS firmware: dmesg | grep -iE 'wpss|wcnss'"
echo "  2. Check Bluetooth dmesg: dmesg | grep -i bluetooth"
echo "  3. Check rfkill: rfkill list bluetooth"
echo "  4. Verify firmware: ls -la /usr/lib/firmware/qca/msbt*"
exit 0
