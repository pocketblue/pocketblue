#!/bin/bash

HCI_TIMEOUT=30
FW_TIMEOUT=120

echo "Fairphone 5 Bluetooth initialization (WCN6750)..."

waited=0
while [ $waited -lt $HCI_TIMEOUT ]; do
    for hci in /sys/class/bluetooth/hci*; do
        if [ -d "$hci" ]; then
            HCI_DEV=$(basename "$hci")
            break 2
        fi
    done
    sleep 1
    ((waited++))
done

if [ -z "${HCI_DEV:-}" ]; then
    echo "ERROR: No Bluetooth HCI device found after ${HCI_TIMEOUT}s"
    exit 1
fi

echo "Found $HCI_DEV after ${waited}s"

if command -v rfkill &>/dev/null; then
    rfkill unblock bluetooth 2>/dev/null || true
fi

waited=0
while [ $waited -lt $FW_TIMEOUT ]; do
    if dmesg 2>/dev/null | grep -q "QCA setup on UART is completed"; then
        echo "QCA firmware loaded after ${waited}s"
        break
    fi
    sleep 1
    ((waited++))
done

if [ $waited -ge $FW_TIMEOUT ]; then
    echo "WARNING: Timed out waiting for QCA firmware (${FW_TIMEOUT}s)"
    echo "Check dmesg for bluetooth firmware errors"
    exit 1
fi

sleep 2

if command -v btmgmt &>/dev/null; then
    btmgmt --index 0 power on 2>/dev/null && echo "Powered on $HCI_DEV via btmgmt" || true
fi

echo "Bluetooth $HCI_DEV ready â€” handing off to bluetoothd"
exit 0
