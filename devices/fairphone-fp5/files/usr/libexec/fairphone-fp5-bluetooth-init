#!/bin/bash

HCI_DEV="hci0"
MAX_RETRIES=5

echo "Fairphone 5 Bluetooth initialization..."

for hci in /sys/class/bluetooth/hci*; do
    if [ -d "$hci" ]; then
        HCI_DEV=$(basename "$hci")
        break
    fi
done

if [ ! -d "/sys/class/bluetooth/$HCI_DEV" ]; then
    echo "No Bluetooth HCI device found"
    exit 1
fi

echo "Found Bluetooth device: $HCI_DEV"

if command -v rfkill &>/dev/null; then
    rfkill unblock bluetooth 2>/dev/null || true
fi

if hciconfig "$HCI_DEV" 2>/dev/null | grep -q "UP RUNNING"; then
    echo "Bluetooth $HCI_DEV is already UP and RUNNING"
    hciconfig "$HCI_DEV"
    exit 0
fi

for retry in $(seq 1 $MAX_RETRIES); do
    echo "Attempt ${retry}/${MAX_RETRIES} to bring up $HCI_DEV..."
    
    hciconfig "$HCI_DEV" down 2>/dev/null || true
    sleep 1
    
    if hciconfig "$HCI_DEV" up 2>/dev/null; then
        sleep 1
        if hciconfig "$HCI_DEV" 2>/dev/null | grep -q "UP RUNNING"; then
            echo "Bluetooth $HCI_DEV initialized successfully"
            hciconfig "$HCI_DEV"
            exit 0
        fi
    fi
    
    sleep 2
done

echo "Bluetooth $HCI_DEV initialization may have issues"
hciconfig "$HCI_DEV" 2>/dev/null || echo "Device not accessible"
exit 0
