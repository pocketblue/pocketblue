#!/bin/bash

echo "==================================="
echo "Fairphone 5 Bluetooth Debug Report"
echo "==================================="

echo ""
echo "1. Firmware Files:"
echo "-------------------"
ls -la /usr/lib/firmware/qca/msbtfw11.* /usr/lib/firmware/qca/msnv11.* 2>/dev/null || echo "  No BT firmware found"
echo ""
echo "  Expected: msbtfw11.mbn, msbtfw11.tlv (symlink -> mbn), msnv11.bin"
if [ -L /usr/lib/firmware/qca/msbtfw11.tlv ]; then
    echo "  .tlv symlink: $(readlink -f /usr/lib/firmware/qca/msbtfw11.tlv)"
else
    echo "  WARNING: msbtfw11.tlv symlink MISSING - kernel may fail to load firmware"
fi

echo ""
echo "2. Remoteproc Status:"
echo "----------------------"
for rproc in /sys/class/remoteproc/remoteproc*/; do
    [ -f "${rproc}name" ] && echo "$(basename $rproc): $(cat ${rproc}name) - $(cat ${rproc}state)"
done

echo ""
echo "3. Bluetooth Devices:"
echo "----------------------"
ls -la /sys/class/bluetooth/ 2>/dev/null || echo "  None"

echo ""
echo "4. bluetoothctl info:"
echo "----------------------"
timeout 3 bluetoothctl show 2>/dev/null || echo "  No controller available"

echo ""
echo "5. rfkill Status:"
echo "------------------"
rfkill list bluetooth 2>/dev/null || echo "  rfkill not available"

echo ""
echo "6. Loaded Modules:"
echo "-------------------"
lsmod | grep -E "bluetooth|btqca|hci_uart|ath11k|cfg80211|mac80211" 2>/dev/null || echo "  None"

echo ""
echo "7. Service Status:"
echo "-------------------"
systemctl status bluetooth.service --no-pager 2>/dev/null | head -20
echo ""
systemctl status fairphone-fp5-bluetooth.service --no-pager 2>/dev/null | head -15

echo ""
echo "8. Recent dmesg (Bluetooth):"
echo "------------------------------"
dmesg | grep -i bluetooth | tail -15 2>/dev/null

echo ""
echo "9. Recent dmesg (QCA/WCN):"
echo "-----------------------------"
dmesg | grep -iE "qca|wcn|hci" | tail -10 2>/dev/null

echo ""
echo "Debug report complete."
