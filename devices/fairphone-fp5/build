#!/usr/bin/env bash

set -uexo pipefail

cp -arfT files/etc /etc

# packages
dnf -y install \
    alsa-utils \
    bluez \
    bluez-tools \
    libcamera \
    libcamera-tools \
    libssc \
    libiio-utils \
    qbootctl \
    qcom-firmware \
    qrtr \
    rmtfs \
    tqftpserv \
    usb_modeswitch \
    v4l-utils \
    media-ctl \
    snapshot

dnf -y install --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    hexagonrpc

dnf -y swap --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    alsa-ucm alsa-ucm-conf-qcom-sc7280

# Re-Install iio-sensor-proxy with Qualcomm SSC support (from COPR)
# https://gitlab.freedesktop.org/hadess/iio-sensor-proxy/-/merge_requests/381
dnf -y swap --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    iio-sensor-proxy iio-sensor-proxy

# install device-specific files (after packages to override defaults)
# This includes udev rules, systemd drop-ins, dracut config, modprobe/modules-load
# config, SELinux policy source and the debug script.
cp -arfT files/usr /usr

# Set executable permissions on helper scripts
chmod +x /usr/libexec/fairphone-fp5-debug
chmod +x /usr/libexec/fairphone-fp5-bt-setup

# Create UCM symlink - ALSA card ID is "F5" but UCM config is in Fairphone/fp5
ln -sf Fairphone/fp5 /usr/share/alsa/ucm2/F5

# Install SELinux policy module for QRTR socket access (CIL format)
# Fedora's iiosensorproxy_t domain lacks permission for qipcrtr_socket
semodule -X 400 -i /usr/share/selinux/packages/iio-sensor-proxy-qrtr.cil

# fairphone-5-firmware (direct install)
FW_COMMIT="a4908f548e6f88965e78b1478af1751b6a854fc9"
FW_URL="https://github.com/FairBlobs/FP5-firmware/archive/${FW_COMMIT}.tar.gz"
FW_DIR="/tmp/FP5-firmware-${FW_COMMIT}"

curl -L "${FW_URL}" | tar xz -C /tmp

mkdir -p /usr/lib/firmware/qcom/qcm6490/fairphone5 \
         /usr/lib/firmware/awinic \
         /usr/share/qcom/qcm6490/Fairphone/fp5/acdb \
         /usr/share/qcom/qcm6490/Fairphone/fp5/dsp \
         /usr/share/qcom/qcm6490/Fairphone/fp5/sensors \
         /usr/share/qcom/qcm6490/Fairphone/fp5/socinfo

FW_DEST="/usr/lib/firmware/qcom/qcm6490/fairphone5"

# Install split firmware files (.mdt + .bXX) - do NOT use pil-squasher
# The kernel's qcom_mdt_loader handles split format natively and it's more reliable
# than squashed .mbn format which can produce corrupt files

# qcom firmware - copy split firmware files (.mdt + .b* segments)
for fw in adsp cdsp modem wpss a660_zap; do
    if [ -f "${FW_DIR}/${fw}.mdt" ]; then
        echo "Installing ${fw} firmware (split format)..."
        # Install the .mdt header file
        install -Dm644 "${FW_DIR}/${fw}.mdt" "${FW_DEST}/${fw}.mdt"
        # Count and install all segment files (.b00, .b01, etc.)
        seg_count=0
        for seg in "${FW_DIR}/${fw}".b*; do
            if [ -f "$seg" ]; then
                install -Dm644 "$seg" "${FW_DEST}/$(basename "$seg")"
                ((seg_count++)) || true
            fi
        done
        echo "  Installed ${seg_count} segment files for ${fw}"
        # Create .mbn symlink pointing to .mdt (kernel accepts both)
        ln -sf "${fw}.mdt" "${FW_DEST}/${fw}.mbn"
    else
        echo "WARNING: ${fw}.mdt not found in firmware archive"
    fi
done

# IPA firmware (kernel expects ipa_fws.mbn, repo has yupik_ipa_fws.*)
if [ -f "${FW_DIR}/yupik_ipa_fws.mdt" ]; then
    install -Dm644 "${FW_DIR}/yupik_ipa_fws.mdt" "${FW_DEST}/ipa_fws.mdt"
    for seg in "${FW_DIR}/yupik_ipa_fws".b*; do
        [ -f "$seg" ] && install -Dm644 "$seg" "${FW_DEST}/$(basename "$seg" | sed 's/yupik_ipa_fws/ipa_fws/')"
    done
    ln -sf "ipa_fws.mdt" "${FW_DEST}/ipa_fws.mbn"
fi

# Venus (video codec) firmware - this is already a single .mbn file
[ -f "${FW_DIR}/vpu20_1v.mbn" ] && install -Dm644 "${FW_DIR}/vpu20_1v.mbn" "${FW_DEST}/venus.mbn"

# Other firmware files (jsn, etc.)
for fw in adspr.jsn adsps.jsn adspua.jsn battmgr.jsn cdspr.jsn modemr.jsn; do
    [ -f "${FW_DIR}/${fw}" ] && install -Dm644 "${FW_DIR}/${fw}" "${FW_DEST}/${fw}"
done

# modem_pr directory
[ -d "${FW_DIR}/modem_pr" ] && cp -a "${FW_DIR}/modem_pr" "${FW_DEST}/"

# audio codec firmware (AW88261 speaker amplifier)
# Install to both paths for kernel compatibility
if [ -f "${FW_DIR}/aw882xx_acf.bin" ]; then
    # Path for awinic generic driver
    install -Dm644 "${FW_DIR}/aw882xx_acf.bin" /usr/lib/firmware/awinic/aw882xx_acf.bin
    # Path for aw88261 driver (matching pmOS)
    install -Dm644 "${FW_DIR}/aw882xx_acf.bin" "${FW_DEST}/aw88261_acf.bin"
    echo "  Installed aw882xx audio amplifier firmware"
fi

# bluetooth firmware from FairBlobs dump
#
# The FairBlobs firmware is extracted from the stock Fairphone 5 ROM and
# contains device-specific NVM configuration (msnv11.bin) with correct RF
# calibration for FP5 hardware. Fedora's linux-firmware ships generic
# Qualcomm-provided versions that may differ.
#
# We must:
# 1. Remove any competing firmware from linux-firmware (compressed or not)
#    to ensure the FairBlobs version is used exclusively
# 2. Install uncompressed copies (the serdev probe fires at t=2.9s during
#    initramfs, before xz/zstd decompressors may be ready)
# 3. Create a .tlv symlink (the QCA driver tries .tlv first, then .mbn)
mkdir -p /usr/lib/firmware/qca

# Remove any linux-firmware versions to avoid version conflicts.
# This includes board-specific NVM variants (msnv11.b09, msnv11.b0a, etc.)
# that linux-firmware ships compressed — the kernel firmware loader may
# prefer these over our uncompressed msnv11.bin from FairBlobs.
rm -f /usr/lib/firmware/qca/msbtfw11.mbn.xz \
      /usr/lib/firmware/qca/msbtfw11.mbn.zst \
      /usr/lib/firmware/qca/msbtfw11.tlv \
      /usr/lib/firmware/qca/msbtfw11.tlv.xz \
      /usr/lib/firmware/qca/msbtfw11.tlv.zst \
      /usr/lib/firmware/qca/msnv11.bin.xz \
      /usr/lib/firmware/qca/msnv11.bin.zst \
      /usr/lib/firmware/qca/msnv11b.bin \
      /usr/lib/firmware/qca/msnv11b.bin.xz \
      /usr/lib/firmware/qca/msnv11b.bin.zst
rm -f /usr/lib/firmware/qca/msnv11.b*.xz \
      /usr/lib/firmware/qca/msnv11.b*.zst
echo "  Removed any competing linux-firmware BT files"

if [ -f "${FW_DIR}/msbtfw11.mbn" ]; then
    install -Dm644 "${FW_DIR}/msbtfw11.mbn" /usr/lib/firmware/qca/msbtfw11.mbn
    # The QCA driver tries .tlv first, then falls back to .mbn.
    # Create symlink so the first lookup succeeds immediately.
    ln -sf msbtfw11.mbn /usr/lib/firmware/qca/msbtfw11.tlv
    echo "  Installed msbtfw11.mbn + .tlv symlink (BT firmware)"
fi
if [ -f "${FW_DIR}/msnv11.bin" ]; then
    install -Dm644 "${FW_DIR}/msnv11.bin" /usr/lib/firmware/qca/msnv11.bin
    echo "  Installed msnv11.bin (FP5-specific NV config from FairBlobs)"  
fi

# GPU firmware (a660_sqe.fw, a660_gmu.bin)
# The msm DRM driver requests firmware as "qcom/a660_sqe.fw", which resolves
# to /usr/lib/firmware/qcom/a660_sqe.fw — NOT the device-specific subdirectory.
GPU_FW_DIR="/usr/lib/firmware/qcom"
GPU_FW_INSTALLED=false
if [ ! -f "${GPU_FW_DIR}/a660_sqe.fw" ]; then
    echo "  a660_sqe.fw not found, downloading from linux-firmware..."
    curl -sL "https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/qcom/a660_sqe.fw" \
        -o "${GPU_FW_DIR}/a660_sqe.fw" && \
        chmod 0644 "${GPU_FW_DIR}/a660_sqe.fw" && \
        echo "  Downloaded a660_sqe.fw" && \
        GPU_FW_INSTALLED=true || \
        echo "  WARNING: Failed to download a660_sqe.fw"
else
    echo "  ✓ a660_sqe.fw already present"
    GPU_FW_INSTALLED=true
fi

if [ ! -f "${GPU_FW_DIR}/a660_gmu.bin" ]; then
    echo "  a660_gmu.bin not found, downloading from linux-firmware..."
    curl -sL "https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/qcom/a660_gmu.bin" \
        -o "${GPU_FW_DIR}/a660_gmu.bin" && \
        chmod 0644 "${GPU_FW_DIR}/a660_gmu.bin" && \
        echo "  Downloaded a660_gmu.bin" || \
        echo "  WARNING: Failed to download a660_gmu.bin"
else
    echo "  ✓ a660_gmu.bin already present"
fi

if [ "$GPU_FW_INSTALLED" = true ] && [ -f "${GPU_FW_DIR}/a660_sqe.fw" ]; then
    echo "  ✓ GPU firmware: OK"
else
    echo "  ⚠ GPU firmware: may be incomplete (display may still work with fallback)"
fi

# hexagon filesystem
[ -d "${FW_DIR}/hexagonfs/acdb" ] && cp -a "${FW_DIR}/hexagonfs/acdb/"* /usr/share/qcom/qcm6490/Fairphone/fp5/acdb/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/dsp" ] && cp -a "${FW_DIR}/hexagonfs/dsp/"* /usr/share/qcom/qcm6490/Fairphone/fp5/dsp/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/sensors" ] && cp -a "${FW_DIR}/hexagonfs/sensors/"* /usr/share/qcom/qcm6490/Fairphone/fp5/sensors/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/socinfo" ] && cp -a "${FW_DIR}/hexagonfs/socinfo" /usr/share/qcom/qcm6490/Fairphone/fp5/

find /usr/lib/firmware/qcom/qcm6490/fairphone5 -type f -exec chmod 0644 {} \;
find /usr/share/qcom/qcm6490/Fairphone/fp5 -type f -exec chmod 0644 {} \;

# Verify critical firmware files are installed
echo "Verifying firmware installation..."
for fw in adsp cdsp modem wpss a660_zap; do
    if [ -f "${FW_DEST}/${fw}.mdt" ] && [ -L "${FW_DEST}/${fw}.mbn" ]; then
        echo "  ✓ ${fw}: OK"
    else
        echo "  ✗ ${fw}: MISSING or incomplete"
        exit 1
    fi
done

if [ -f /usr/lib/firmware/qca/msbtfw11.mbn ] && [ -L /usr/lib/firmware/qca/msbtfw11.tlv ] && [ -f /usr/lib/firmware/qca/msnv11.bin ]; then
    echo "  ✓ bluetooth: OK (msbtfw11.mbn + .tlv symlink + msnv11.bin from FairBlobs)"
else
    echo "  ✗ bluetooth: MISSING or incomplete"
    exit 1
fi

if [ -f /usr/lib/firmware/qcom/a660_sqe.fw ]; then
    echo "  ✓ gpu: OK (a660_sqe.fw)"
else
    echo "  ✗ gpu: a660_sqe.fw MISSING"
    exit 1
fi

# Verify no competing compressed firmware from linux-firmware remains
for conflict in /usr/lib/firmware/qca/msbtfw11.mbn.xz /usr/lib/firmware/qca/msbtfw11.mbn.zst \
                /usr/lib/firmware/qca/msnv11.bin.xz /usr/lib/firmware/qca/msnv11.bin.zst \
                /usr/lib/firmware/qca/msnv11.b*.xz /usr/lib/firmware/qca/msnv11.b*.zst; do
    if [ -f "$conflict" ]; then
        echo "  ⚠ WARNING: competing firmware file found: $conflict"
        echo "    Removing to avoid version mismatch with FairBlobs firmware"
        rm -f "$conflict"
    fi
done

echo "Firmware installation complete."
ls -la "${FW_DEST}/"
echo "Bluetooth firmware:"
ls -la /usr/lib/firmware/qca/msbtfw11.* /usr/lib/firmware/qca/msnv11.* 2>/dev/null || true

rm -rf "${FW_DIR}"

# kernel (from lorbus/misc copr)
dnf -y remove \
    kernel \
    kernel-core \
    kernel-modules \
    kernel-modules-core
dnf -y install --refresh --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    kernel

systemctl enable \
    hexagonrpcd-adsp-sensorspd.service \
    hexagonrpcd-adsp-rootpd.service \
    bluetooth.service \
    tqftpserv.service \
    qbootctl.service \
    rmtfs.service

KERNEL_SUFFIX=""
QUALIFIED_KERNEL="$(rpm -qa | grep -P 'kernel-(|'"$KERNEL_SUFFIX"'-)(\d+\.\d+\.\d+)' | sed -E 's/kernel-(|'"$KERNEL_SUFFIX"'-)//')"
export DRACUT_NO_XATTR=1
/usr/bin/dracut --no-hostonly --kver "$QUALIFIED_KERNEL" --reproducible -v --add ostree -f "/lib/modules/$QUALIFIED_KERNEL/initramfs.img"
chmod 0600 "/lib/modules/$QUALIFIED_KERNEL/initramfs.img"
