#!/usr/bin/env bash

set -uexo pipefail

cp -arfT files/etc /etc

# packages
dnf -y remove alsa-ucm # conflicts with alsa-ucm-conf-qcom-sc7280
dnf -y install \
    alsa-ucm-conf-qcom-sc7280 \
    bluez \
    bluez-tools \
    hexagonrpc \
    libcamera \
    libcamera-tools \
    libssc \
    libiio-utils \
    mobility-tweaks \
    qbootctl \
    qcom-firmware \
    qrtr \
    rmtfs \
    tqftpserv \
    usb_modeswitch \
    v4l-utils \
    media-ctl

# Re-Install iio-sensor-proxy with Qualcomm SSC support (from COPR)
# https://gitlab.freedesktop.org/hadess/iio-sensor-proxy/-/merge_requests/381
dnf -y swap --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    iio-sensor-proxy iio-sensor-proxy

# install device-specific files (after packages to override defaults)
# This includes our custom hexagonrpcd-adsp-sensorspd.service
cp -arfT files/usr /usr

# Set executable permissions on helper scripts
chmod +x /usr/libexec/fairphone-fp5-bluetooth-debug
chmod +x /usr/libexec/fairphone-fp5-debug

# fairphone-5-firmware (direct install)
FW_COMMIT="a4908f548e6f88965e78b1478af1751b6a854fc9"
FW_URL="https://github.com/FairBlobs/FP5-firmware/archive/${FW_COMMIT}.tar.gz"
FW_DIR="/tmp/FP5-firmware-${FW_COMMIT}"

curl -L "${FW_URL}" | tar xz -C /tmp

mkdir -p /usr/lib/firmware/qcom/qcm6490/fairphone5 \
         /usr/lib/firmware/awinic \
         /usr/share/qcom/qcm6490/fairphone5/acdb \
         /usr/share/qcom/qcm6490/fairphone5/dsp \
         /usr/share/qcom/qcm6490/fairphone5/sensors \
         /usr/share/qcom/qcm6490/fairphone5/socinfo

FW_DEST="/usr/lib/firmware/qcom/qcm6490/fairphone5"

# Install split firmware files (.mdt + .bXX) - do NOT use pil-squasher
# The kernel's qcom_mdt_loader handles split format natively and it's more reliable
# than squashed .mbn format which can produce corrupt files

# qcom firmware - copy split firmware files (.mdt + .b* segments)
for fw in adsp cdsp modem wpss a660_zap; do
    if [ -f "${FW_DIR}/${fw}.mdt" ]; then
        echo "Installing ${fw} firmware (split format)..."
        # Install the .mdt header file
        install -Dm644 "${FW_DIR}/${fw}.mdt" "${FW_DEST}/${fw}.mdt"
        # Count and install all segment files (.b00, .b01, etc.)
        seg_count=0
        for seg in "${FW_DIR}/${fw}".b*; do
            if [ -f "$seg" ]; then
                install -Dm644 "$seg" "${FW_DEST}/$(basename "$seg")"
                ((seg_count++)) || true
            fi
        done
        echo "  Installed ${seg_count} segment files for ${fw}"
        # Create .mbn symlink pointing to .mdt (kernel accepts both)
        ln -sf "${fw}.mdt" "${FW_DEST}/${fw}.mbn"
    else
        echo "WARNING: ${fw}.mdt not found in firmware archive"
    fi
done

# IPA firmware (kernel expects ipa_fws.mbn, repo has yupik_ipa_fws.*)
if [ -f "${FW_DIR}/yupik_ipa_fws.mdt" ]; then
    install -Dm644 "${FW_DIR}/yupik_ipa_fws.mdt" "${FW_DEST}/ipa_fws.mdt"
    for seg in "${FW_DIR}/yupik_ipa_fws".b*; do
        [ -f "$seg" ] && install -Dm644 "$seg" "${FW_DEST}/$(basename "$seg" | sed 's/yupik_ipa_fws/ipa_fws/')"
    done
    ln -sf "ipa_fws.mdt" "${FW_DEST}/ipa_fws.mbn"
fi

# Venus (video codec) firmware - this is already a single .mbn file
[ -f "${FW_DIR}/vpu20_1v.mbn" ] && install -Dm644 "${FW_DIR}/vpu20_1v.mbn" "${FW_DEST}/venus.mbn"

# Other firmware files (jsn, etc.)
for fw in adspr.jsn adsps.jsn adspua.jsn battmgr.jsn cdspr.jsn modemr.jsn; do
    [ -f "${FW_DIR}/${fw}" ] && install -Dm644 "${FW_DIR}/${fw}" "${FW_DEST}/${fw}"
done

# modem_pr directory
[ -d "${FW_DIR}/modem_pr" ] && cp -a "${FW_DIR}/modem_pr" "${FW_DEST}/"

# audio codec firmware (AW88261 speaker amplifier)
# Install to both paths for kernel compatibility
if [ -f "${FW_DIR}/aw882xx_acf.bin" ]; then
    # Path for awinic generic driver
    install -Dm644 "${FW_DIR}/aw882xx_acf.bin" /usr/lib/firmware/awinic/aw882xx_acf.bin
    # Path for aw88261 driver (matching pmOS)
    install -Dm644 "${FW_DIR}/aw882xx_acf.bin" "${FW_DEST}/aw88261_acf.bin"
    echo "  Installed aw882xx audio amplifier firmware"
fi

# bluetooth firmware from FairBlobs dump
# The kernel's serdev probe requests firmware very early at boot, before the
# xz decompressor may be ready. Fedora's linux-firmware ships compressed
# .mbn.xz/.tlv.xz which fail to load at this stage, leaving hci0 permanently
# broken. Install uncompressed copies so the early probe succeeds.
mkdir -p /usr/lib/firmware/qca
if [ -f "${FW_DIR}/msbtfw11.mbn" ]; then
    install -Dm644 "${FW_DIR}/msbtfw11.mbn" /usr/lib/firmware/qca/msbtfw11.mbn
    echo "  Installed msbtfw11.mbn (uncompressed BT firmware)"
fi
if [ -f "${FW_DIR}/msnv11.bin" ]; then
    install -Dm644 "${FW_DIR}/msnv11.bin" /usr/lib/firmware/qca/msnv11.bin
    echo "  Installed msnv11.bin (device-specific NV config)"
fi

# GPU firmware (a660_sqe.fw, a660_gmu.bin)
# The kernel looks in qcom/qcm6490/fairphone5/ first, then falls back to qcom/
# Try to symlink from qcom-firmware first, otherwise download from linux-firmware
GPU_FW_INSTALLED=false
if [ -f /usr/lib/firmware/qcom/a660_sqe.fw ]; then
    ln -sf ../../a660_sqe.fw "${FW_DEST}/a660_sqe.fw"
    echo "  Linked a660_sqe.fw from qcom-firmware"
    GPU_FW_INSTALLED=true
else
    echo "  a660_sqe.fw not found in qcom-firmware, downloading from linux-firmware..."
    curl -sL "https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/qcom/a660_sqe.fw" -o "${FW_DEST}/a660_sqe.fw" && \
        chmod 0644 "${FW_DEST}/a660_sqe.fw" && \
        echo "  Downloaded a660_sqe.fw from linux-firmware" && \
        GPU_FW_INSTALLED=true || \
        echo "  WARNING: Failed to download a660_sqe.fw"
fi

if [ -f /usr/lib/firmware/qcom/a660_gmu.bin ]; then
    ln -sf ../../a660_gmu.bin "${FW_DEST}/a660_gmu.bin"
    echo "  Linked a660_gmu.bin from qcom-firmware"
else
    echo "  a660_gmu.bin not found in qcom-firmware, downloading from linux-firmware..."
    curl -sL "https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/qcom/a660_gmu.bin" -o "${FW_DEST}/a660_gmu.bin" && \
        chmod 0644 "${FW_DEST}/a660_gmu.bin" && \
        echo "  Downloaded a660_gmu.bin from linux-firmware" || \
        echo "  WARNING: Failed to download a660_gmu.bin"
fi

if [ "$GPU_FW_INSTALLED" = true ] && [ -f "${FW_DEST}/a660_sqe.fw" ]; then
    echo "  ✓ GPU firmware: OK"
else
    echo "  ⚠ GPU firmware: may be incomplete (display may still work with fallback)"
fi

# hexagon filesystem
[ -d "${FW_DIR}/hexagonfs/acdb" ] && cp -a "${FW_DIR}/hexagonfs/acdb/"* /usr/share/qcom/qcm6490/fairphone5/acdb/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/dsp" ] && cp -a "${FW_DIR}/hexagonfs/dsp/"* /usr/share/qcom/qcm6490/fairphone5/dsp/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/sensors" ] && cp -a "${FW_DIR}/hexagonfs/sensors/"* /usr/share/qcom/qcm6490/fairphone5/sensors/ 2>/dev/null || true
[ -d "${FW_DIR}/hexagonfs/socinfo" ] && cp -a "${FW_DIR}/hexagonfs/socinfo" /usr/share/qcom/qcm6490/fairphone5/

find /usr/lib/firmware/qcom/qcm6490/fairphone5 -type f -exec chmod 0644 {} \;
find /usr/share/qcom/qcm6490/fairphone5 -type f -exec chmod 0644 {} \;

# Verify critical firmware files are installed
echo "Verifying firmware installation..."
for fw in adsp cdsp modem wpss a660_zap; do
    if [ -f "${FW_DEST}/${fw}.mdt" ] && [ -L "${FW_DEST}/${fw}.mbn" ]; then
        echo "  ✓ ${fw}: OK"
    else
        echo "  ✗ ${fw}: MISSING or incomplete"
        exit 1
    fi
done

if [ -f /usr/lib/firmware/qca/msbtfw11.mbn ] && [ -f /usr/lib/firmware/qca/msnv11.bin ]; then
    echo "  ✓ bluetooth: OK (msbtfw11.mbn + msnv11.bin)"
else
    echo "  ✗ bluetooth: MISSING or incomplete"
    exit 1
fi

echo "Firmware installation complete."
ls -la "${FW_DEST}/"
echo "Bluetooth firmware:"
ls -la /usr/lib/firmware/qca/msbtfw11.* /usr/lib/firmware/qca/msnv11.* 2>/dev/null || true

rm -rf "${FW_DIR}"

# kernel (from lorbus/misc copr)
dnf -y remove \
    kernel \
    kernel-core \
    kernel-modules \
    kernel-modules-core
dnf -y install --refresh --repo='copr:copr.fedorainfracloud.org:lorbus:misc' \
    kernel

# services
# Mask generic/unused hexagonrpcd services
# Note: hexagonrpcd-adsp-sensorspd is enabled (needed for sensors via libssc)
# The others require fastrpc devices that may not be available on this SoC
systemctl mask \
    hexagonrpcd-adsp.service \
    hexagonrpcd-adsp-rootpd.service \
    hexagonrpcd-sdsp.service

systemctl enable \
    hexagonrpcd-adsp-sensorspd.service \
    tqftpserv.service \
    qbootctl.service \
    rmtfs.service

KERNEL_SUFFIX=""
QUALIFIED_KERNEL="$(rpm -qa | grep -P 'kernel-(|'"$KERNEL_SUFFIX"'-)(\d+\.\d+\.\d+)' | sed -E 's/kernel-(|'"$KERNEL_SUFFIX"'-)//')"
export DRACUT_NO_XATTR=1
/usr/bin/dracut --no-hostonly --kver "$QUALIFIED_KERNEL" --reproducible -v --add ostree -f "/lib/modules/$QUALIFIED_KERNEL/initramfs.img"
chmod 0600 "/lib/modules/$QUALIFIED_KERNEL/initramfs.img"
